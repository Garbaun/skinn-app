function b64ToUint8Array(base64String){const padding='='.repeat((4-base64String.length%4)%4);const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/');const rawData=atob(base64);const outputArray=new Uint8Array(rawData.length);for(let i=0;i<rawData.length;++i){outputArray[i]=rawData.charCodeAt(i);}return outputArray}
async function ensureSW(){if(!('serviceWorker'in navigator))throw new Error('no-sw');const reg=await navigator.serviceWorker.getRegistration();return reg||navigator.serviceWorker.register('service-worker.js')}
async function subscribePush(){if(!('Notification'in window)&&!('PushManager'in window))throw new Error('no-push');const perm=await Notification.requestPermission();if(perm!=='granted')throw new Error('denied');const reg=await ensureSW();const key=window.PushConfig&&window.PushConfig.vapidPublicKey;if(!key)throw new Error('no-key');const sub=await reg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:b64ToUint8Array(key)});const endpoint=window.PushConfig&&window.PushConfig.subscribeEndpoint;if(endpoint){try{await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(sub)})}catch(e){}}return sub}
window.PushSubscribe={subscribePush}